version: '3.8'

services:
  # Backend FastAPI service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: todo-backend
    ports:
      - "8000:8000"
    environment:
      # Use Neon database (cloud) - recommended
      DATABASE_URL: ${DATABASE_URL}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      HOST: 0.0.0.0
      PORT: 8000
    volumes:
      # Mount source code for development hot-reload
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - todo-network
    restart: unless-stopped

  # Optional: Local PostgreSQL for development
  # Comment this out if using Neon cloud database
  postgres:
    image: postgres:16-alpine
    container_name: todo-postgres-dev
    environment:
      POSTGRES_USER: todouser
      POSTGRES_PASSWORD: todopass
      POSTGRES_DB: tododb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U todouser" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - todo-network

networks:
  todo-network:
    driver: bridge

volumes:
  postgres_data:

    # Usage:
    # 1. Copy .env.docker to .env in project root
    # 2. Start all services: docker-compose up -d
    # 3. View logs: docker-compose logs -f backend
    # 4. Stop services: docker-compose down
    # 5. Rebuild after code changes: docker-compose up -d --build backend
